# Q3D 初始前端框架说明（里程碑1）

本文档描述当前仓库已落地的 **Q3D 前端初始框架**：一个基于 Three.js 的在线 3D 机械设计编辑器雏形，支持三基准面（XY/YZ/ZX）与在选定平面上进行二维草图绘制（线段/矩形/圆 + 网格捕捉），为后续三维特征（如拉伸凸台）提供基础。

> 范围说明：按项目要求，**暂不考虑后端**。本阶段关注前端架构、渲染与交互的最小闭环。

---

## 目标与验收（里程碑1）

- **基本界面**：三栏布局（左侧工具/特征区 + 中央 3D 视口 + 右侧属性面板）。
- **三基准面**：场景中展示相互垂直的 `XY` / `YZ` / `ZX` 基准面（半透明）与其网格线。
- **选面进入草图**：鼠标点击任意基准面后高亮该面并进入 “Sketch” 模式。
- **二维绘图**：在当前激活平面上绘制 **线段/矩形/圆**，支持 **网格捕捉**。
- **最小撤销/重做**：支持按钮与快捷键。

---

## 技术栈与依赖

- **框架**：React + Vite + TypeScript
- **渲染**：Three.js
- **状态管理**：zustand

安装的关键依赖可见：`frontend/package.json`。

---

## 如何运行

在仓库根目录执行：

```bash
cd frontend
npm install
npm run dev
```

> 备注：你当前 Node 版本若低于 Vite 要求版本，构建时可能会出现提示，但通常不影响开发启动。建议后续升级 Node 以消除提示。

---

## 交互说明（用户视角）

- **视图模式（View）**
  - 左键点击任意基准面：切换到 **草图模式（Sketch）** 并激活该平面
- **草图模式（Sketch）**
  - 选择工具：线段 / 矩形 / 圆
  - **两次点击完成绘制**：第一次确定起点/圆心，第二次确定终点/对角点/半径
  - 移动鼠标会显示当前绘制的 **预览(draft)** 轮廓
  - 网格捕捉：右侧属性面板可开关与调整网格间距
- **快捷键**
  - `Esc`：退出草图回到视图模式
  - `Ctrl+Z`：撤销
  - `Ctrl+Y` / `Ctrl+Shift+Z`：重做

---

## 项目结构（当前实现）

前端代码位于 `frontend/`：

- `frontend/src/app/`：应用入口与布局
  - `app/App.tsx`：应用根组件
  - `app/layout/EditorLayout.tsx`：三栏编辑器布局
- `frontend/src/viewport/`：视口层（React 组件）
  - `viewport/ThreeViewport.tsx`：承载 WebGL canvas，创建引擎与输入控制器
- `frontend/src/engine/`：渲染引擎（Three.js）
  - `engine/ThreeEngine.ts`：scene/camera/renderer、OrbitControls、渲染循环、resize
  - `engine/createBaselinePlanes.ts`：创建 XY/YZ/ZX 三基准面（可视 + 可拾取）
- `frontend/src/input/`：输入控制
  - `input/InputController.ts`：raycast 选面、草图绘制、快捷键（撤销/重做/退出）
- `frontend/src/sketch/`：草图系统
  - `sketch/planeMath.ts`：世界坐标与平面2D坐标（u,v）的转换、网格捕捉
  - `sketch/SketchSystem.ts`：将草图实体渲染为位于平面上的线框
- `frontend/src/state/`：编辑器状态（zustand）
  - `state/editorStore.ts`：mode/tool/activePlane/grid/snap/entities/history
- `frontend/src/ui/`：面板 UI
  - `ui/Toolbar.tsx`：工具选择、撤销/重做
  - `ui/PropertiesPanel.tsx`：网格间距、捕捉开关、当前平面

---

## 核心设计（面向实现）

### 1) 编辑器模式与状态

在 `state/editorStore.ts` 维护：

- `mode`：`view | sketch`
- `activePlane`：`XY | YZ | ZX | null`
- `tool`：`select | line | rect | circle`
- `gridSize` / `snapEnabled`
- `sketchEntities`：草图实体数组（line/rect/circle）
- `draftEntity`：绘制过程中的预览实体（鼠标移动更新）
- `past/future`：撤销/重做栈（最小实现）

### 2) 基准面与拾取

- 在 `engine/createBaselinePlanes.ts` 构造三基准面，每个平面包含：
  - **可见层**：半透明平面 + 网格线
  - **拾取层**：用于 raycast 的平面 mesh，并在 `userData.planeId` 中保存 planeId
- `input/InputController.ts` 在 pointerdown 时对 plane meshes 进行 raycast：
  - View 模式：命中平面则设置 `activePlane` 并切换到 Sketch
  - Sketch 模式：允许点击平面切换激活面

### 3) “世界坐标 ↔ 平面2D”转换（草图的关键）

草图实体以二维坐标 `(u,v)` 存储，渲染时转回 world：

- `worldToUV(world, basis)`：\n
  - \(u = (world-origin)·uAxis\)\n
  - \(v = (world-origin)·vAxis\)
- `uvToWorld(uv, basis)`：\n
  - \(world = origin + uAxis*u + vAxis*v\)
- `snapUV(uv, grid)`：把 `(u,v)` round 到网格点

其中 `basis`（原点 + 法向 + u/v 轴）由 `ThreeEngine.getPlaneBasis(planeId)` 提供。

### 4) 草图渲染（SketchSystem）

`SketchSystem` 接收：

- `basis`：当前激活平面的坐标基
- `entities + draft`：草图实体与预览实体

然后将每个实体转换为 polyline，生成 Three.js `Line` 并放入 `sketchGroup`。为避免 z-fighting，草图线条会沿平面法向做一个很小的偏移（zOffset）。

---

## 当前能力与限制

- **已支持**：三基准面显示/拾取；在平面上绘制线段/矩形/圆；网格捕捉；撤销/重做；草图实时预览。
- **暂不支持（后续里程碑）**：
  - 约束求解（水平/垂直/相切/尺寸等）
  - 草图拓扑（闭合轮廓识别、区域/面生成）
  - 三维特征（拉伸/旋转/倒角/圆角等）
  - 参数化与特征树、装配约束、零件库、协作等

---

## 后续扩展建议（面向里程碑2+）

1. **草图到可用于建模的“轮廓”**：引入闭合轮廓识别与轮廓图结构（half-edge/graph），为拉伸做准备。  
2. **草图约束与求解**：最小约束（水平/垂直/重合）+ 轻量求解器（可先自研简单规则，后续再引入成熟库）。  
3. **特征建模数据结构**：Feature（输入草图/参数）→ B-Rep/mesh 生成 → 渲染与可编辑回放。  
4. **对象选择与高亮体系**：统一 picking（平面/草图实体/实体边面）与选择集。  
5. **性能与工程化**：按需拆包、渲染层与状态层解耦、历史记录做成命令模式（Command）。  


